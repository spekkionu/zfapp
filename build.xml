<?xml version="1.0" encoding="UTF-8"?>
<!-- Generated by PHP Project Wizard (PPW) 1.0.4 on Fri Aug 26 11:02:43 PDT 2011 -->

<project name="zfapp" default="build" basedir=".">
  <property name="source" value="src"/>

  <!-- Add Custom Tasks to the include path -->
  <includepath classpath="scripts/tasks/closure/tasks" />
  <taskdef name="yuicompressor" classname="YuiCompressorTask" />
  <taskdef name="closure" classname="ClosureTask" />

  <target name="clean" depends="clear-cache" description="Clean up and create artifact directories">
    <delete dir="build/api"/>
    <delete dir="build/code-browser"/>
    <delete dir="build/coverage"/>
    <delete dir="build/logs"/>
    <delete dir="build/pdepend"/>

    <mkdir dir="build/api"/>
    <mkdir dir="build/code-browser"/>
    <mkdir dir="build/coverage"/>
    <mkdir dir="build/logs"/>
    <mkdir dir="build/pdepend"/>
  </target>

  <target name="clear-cache" description="Clears cache folders">
    <delete dir="src/system/cache" includeemptydirs="false" failonerror="false" />
    <mkdir dir="src/system/cache" mode="0777"/>
  </target>

  <target name="init" description="Create needed directories and set permissions">
    <echo message="Create private directories" />
    <mkdir dir="src/system/cache" mode="0777"/>
    <mkdir dir="src/system/logs" mode="0777" />
    <mkdir dir="src/system/userfiles" mode="0777" />
    <mkdir dir="src/system/configs/data" />
    <mkdir dir="src/system/configs/data/fixtures" />
    <mkdir dir="src/system/configs/data/migrations" />
    <mkdir dir="src/system/configs/data/schema" />
    <mkdir dir="src/system/configs/data/sql" />
    <mkdir dir="src/system/scripts" />
    <echo message="Create public directories" />
    <mkdir dir="src/public_html/cached" mode="0777" />
    <mkdir dir="src/public_html/userfiles" mode="0777" />
  </target>

  <target name="phpunit" description="Run unit tests using PHPUnit and generates junit.xml and clover.xml">
    <coverage-setup database="build/coverage/coverage.db">
      <fileset dir="${source}/system">
        <include name="forms/**.php" />
        <include name="models/**.php" />
        <include name="application/**.php" />
        <include name="library/**.php" />
        <exclude name="library/vendor/*" />
      </fileset>
    </coverage-setup>
    <delete dir="tests/_data/cache" includeemptydirs="false" failonerror="false" />
    <mkdir dir="tests/_data/cache" mode="0777"/>
    <phpunit haltonerror="false" bootstrap="tests/bootstrap.php" codecoverage="true" >
      <formatter type="clover" todir="build/logs" outfile="clover.xml"></formatter>
      <formatter type="xml" todir="build/logs" outfile="junit.xml"></formatter>
      <batchtest>
        <fileset dir="tests/unit">
          <include name="**/*Test*.php"/>
        </fileset>
      </batchtest>
    </phpunit>
    <coverage-report outfile="build/logs/coverage.xml">
      <report todir="build/coverage" styledir="scripts/phing"/>
    </coverage-report>
  </target>

  <target name="pdepend" description="Generate jdepend.xml and software metrics charts using PHP_Depend">
    <phpdepend>
      <fileset dir="${source}/system">
        <include name="forms/**.php" />
        <include name="models/**.php" />
        <include name="application/**.php" />
        <include name="library/**.php" />
        <exclude name="library/vendor/*" />
      </fileset>
      <logger type="jdepend-xml" outfile="build/logs/jdepend.xml"/>
      <logger type="jdepend-chart" outfile="build/pdepend/dependencies.svg"/>
      <logger type="overview-pyramid" outfile="build/pdepend/overview-pyramid.svg"/>
    </phpdepend>
  </target>

  <target name="phpmd" description="Generate pmd.xml using PHPMD">
    <phpmd rulesets="codesize,design,naming,unusedcode">
      <fileset dir="${source}/system">
        <include name="forms/**.php" />
        <include name="models/**.php" />
        <include name="application/**.php" />
        <include name="library/**.php" />
        <exclude name="library/vendor/*" />
      </fileset>
      <formatter type="xml" outfile="build/logs/pmd.xml"/>
    </phpmd>
  </target>

  <!--
  <target name="phpcpd" description="Generate pmd-cpd.xml using PHPCPD">
    <phpcpd>
      <fileset dir="${source}/system">
        <include name="forms/**.php" />
        <include name="models/**.php" />
        <include name="application/**.php" />
        <include name="library/**.php" />
        <exclude name="library/vendor/*" />
      </fileset>
      <formatter type="pmd" outfile="build/logs/pmd-cpd.xml"/>
    </phpcpd>
  </target>
  -->

  <target name="phploc" description="Generate phploc.csv">
    <exec command="phploc --log-csv build/logs/phploc.csv ${source}/system" passthru="true" />
  </target>

  <target name="phpcs" description="Generate checkstyle.xml using PHP_CodeSniffer">
    <resolvepath propertyName="standard" file="${project.basedir}/scripts/tasks/phpcs/Spekkionu"/>
    <phpcodesniffer standard="${standard}" showWarnings="false">
      <fileset dir="${source}/system">
        <include name="forms/**.php" />
        <include name="models/**.php" />
        <include name="application/**.php" />
        <include name="library/**.php" />
        <exclude name="library/vendor/*" />
      </fileset>
      <formatter type="default" usefile="false"/>
      <formatter type="checkstyle" outfile="build/logs/checkstyle.xml"/>
    </phpcodesniffer>
  </target>

  <target name="phpdoc" description="Generate API documentation using PHPDocumentor2">
    <phpdoc2 destdir="build/phpdoc" template="responsive">
      <fileset dir="${source}/system">
        <include name="forms/**.php" />
        <include name="models/**.php" />
        <include name="application/**.php" />
        <include name="library/**.php" />
        <exclude name="library/vendor/*" />
      </fileset>
    </phpdoc2>
  </target>

	<target name="apigen" description="Generate API documentation using apigen">
    <resolvepath propertyName="src" file="${source}"/>
    <apigen source="${source}/system" destination="build/api" exclude="${src}/system/cache,${src}/system/logs,${src}/system/configs,${src}/system/userfiles,${src}/system/mvc.php,*/tests/*" skipdocpath="${src}/system/library/vendor/*" title="API Documentation" deprecated="true" todo="false" sourcecode="true" />
  </target>

  <target name="phpcb" description="Aggregate tool output with PHP_CodeBrowser">
    <exec command="phpcb --log build/logs --source ${source}/system --output build/code-browser" passthru="true" />
  </target>

  <target name="build" depends="clean,phpunit,pdepend,phpmd,phpcs,phploc,apigen,phpcb"/>

  <target name="cssmin" description="Combines and compresses admin css files">
    <mkdir dir="build/tmp"/>
    <delete file="${source}/public_html/assets/styles/admin.min.css"/>
    <copy file="${source}/public_html/assets/styles/admin.css" tofile="build/tmp/admin.min.css" overwrite="true" />
    <echo message="Compress combined css file"/>
    <yuicompressor target="${source}/public_html/assets/styles" type="css" file="build/tmp/admin.min.css" compressorjar="${project.basedir}/scripts/tasks/compressor/yuicompressor.jar"  verbose="true" />
    <delete dir="build/tmp"/>
  </target>

  <target name="jsmin" description="Combines and compresses javascript files">
    <echo message="Combine and compress admin js files" />
    <delete file="${source}/public_html/assets/scripts/admin.min.js"/>

    <closure target="${source}/public_html/assets/scripts/admin.min.js" merge="true" closurejar="${project.basedir}/scripts/tasks/compressor/compiler.jar">
      <filelist dir="${source}/public_html/assets" listfile="${source}/public_html/assets/scripts/admin.txt"/>
    </closure>
  </target>



</project>
